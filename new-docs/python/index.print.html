<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.127.0"><meta name=generator content="Relearn 7.3.2"><meta name=description content="Introduction Most Python3 scripts and plugins shall be located below the python3 directory. The structure of the directory is as follows:
python3/bin: This contains files installed in /opt/xensource/bin and are meant to be run by users python3/libexec: This contains files installed in /opt/xensource/libexec and are meant to only be run by xapi and other daemons. python3/packages: Contains files to be installed in pythonâ€™s site-packages are meant to be modules and packages to be imported by other scripts or executed via python3 -m python3/plugins: This contains files that are meant to be xapi plugins python3/tests: Tests for testing and covering the Python scripts and plugins Dependencies for development and testing In GitHub CI and local testing, we can use pre-commit to execute the tests."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Python :: XAPI Toolstack Developer Documentation"><meta name=twitter:description content="Introduction Most Python3 scripts and plugins shall be located below the python3 directory. The structure of the directory is as follows:
python3/bin: This contains files installed in /opt/xensource/bin and are meant to be run by users python3/libexec: This contains files installed in /opt/xensource/libexec and are meant to only be run by xapi and other daemons. python3/packages: Contains files to be installed in pythonâ€™s site-packages are meant to be modules and packages to be imported by other scripts or executed via python3 -m python3/plugins: This contains files that are meant to be xapi plugins python3/tests: Tests for testing and covering the Python scripts and plugins Dependencies for development and testing In GitHub CI and local testing, we can use pre-commit to execute the tests."><meta property="og:url" content="https://xapi-project.github.io/new-docs/python/index.html"><meta property="og:site_name" content="XAPI Toolstack Developer Documentation"><meta property="og:title" content="Python :: XAPI Toolstack Developer Documentation"><meta property="og:description" content="Introduction Most Python3 scripts and plugins shall be located below the python3 directory. The structure of the directory is as follows:
python3/bin: This contains files installed in /opt/xensource/bin and are meant to be run by users python3/libexec: This contains files installed in /opt/xensource/libexec and are meant to only be run by xapi and other daemons. python3/packages: Contains files to be installed in pythonâ€™s site-packages are meant to be modules and packages to be imported by other scripts or executed via python3 -m python3/plugins: This contains files that are meant to be xapi plugins python3/tests: Tests for testing and covering the Python scripts and plugins Dependencies for development and testing In GitHub CI and local testing, we can use pre-commit to execute the tests."><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Python :: XAPI Toolstack Developer Documentation"><meta itemprop=description content="Introduction Most Python3 scripts and plugins shall be located below the python3 directory. The structure of the directory is as follows:
python3/bin: This contains files installed in /opt/xensource/bin and are meant to be run by users python3/libexec: This contains files installed in /opt/xensource/libexec and are meant to only be run by xapi and other daemons. python3/packages: Contains files to be installed in pythonâ€™s site-packages are meant to be modules and packages to be imported by other scripts or executed via python3 -m python3/plugins: This contains files that are meant to be xapi plugins python3/tests: Tests for testing and covering the Python scripts and plugins Dependencies for development and testing In GitHub CI and local testing, we can use pre-commit to execute the tests."><meta itemprop=wordCount content="539"><title>Python :: XAPI Toolstack Developer Documentation</title>
<link href=https://xapi-project.github.io/new-docs/python/index.html rel=canonical type=text/html title="Python :: XAPI Toolstack Developer Documentation"><link href=/new-docs/python/index.xml rel=alternate type=application/rss+xml title="Python :: XAPI Toolstack Developer Documentation"><link href=/new-docs/images/favicon.png?1764583491 rel=icon type=image/png><link href=/new-docs/css/fontawesome-all.min.css?1764583491 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fontawesome-all.min.css?1764583491 rel=stylesheet></noscript><link href=/new-docs/css/auto-complete.css?1764583491 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/auto-complete.css?1764583491 rel=stylesheet></noscript><link href=/new-docs/css/perfect-scrollbar.min.css?1764583491 rel=stylesheet><link href=/new-docs/css/theme.min.css?1764583491 rel=stylesheet><link href=/new-docs/css/format-print.min.css?1764583491 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://xapi-project.github.io/new-docs",window.relearn.min=`.min`,window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.themevariants=["auto","zen-light","zen-dark","red","blue","green","learn","neon","relearn-light","relearn-bright","relearn-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}}))},window.relearn.markVariant=function(){var t=window.localStorage.getItem(window.relearn.absBaseUri+"/variant"),e=document.querySelector("#R-select-variant");e&&(e.value=t)},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant(),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link rel=stylesheet href=https://xapi-project.github.io/new-docs/css/misc.css></head><body class="mobile-support print" data-url=/new-docs/python/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#dependencies-for-development-and-testing>Dependencies for development and testing</a></li><li><a href=#coverage>Coverage</a></li><li><a href=#pytest>Pytest</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/index.html><span itemprop=name>XAPI Toolstack Developer Guide</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Python</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-edit" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=https://github.com/xapi-project/xen-api/edit/master/doc/content/python/_index.md target=_blank title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a></div><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/python/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/design/xenprep/index.html title="XenPrep (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/xcp-rrdd/index.html title="RRDD (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable python" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=python>Python</h1><h2 id=introduction>Introduction</h2><p>Most Python3 scripts and plugins shall be located below the <code>python3</code> directory.
The structure of the directory is as follows:</p><ul><li><code>python3/bin</code>: This contains files installed in <code>/opt/xensource/bin</code>
and are meant to be run by users</li><li><code>python3/libexec</code>: This contains files installed in <code>/opt/xensource/libexec</code>
and are meant to only be run by <code>xapi</code> and other daemons.</li><li><code>python3/packages</code>: Contains files to be installed in python&rsquo;s <code>site-packages</code>
are meant to be modules and packages to be imported by other scripts
or executed via <code>python3 -m</code></li><li><code>python3/plugins</code>: This contains files that
are meant to be <code>xapi</code> plugins</li><li><code>python3/tests</code>: Tests for testing and covering the Python scripts and plugins</li></ul><h2 id=dependencies-for-development-and-testing>Dependencies for development and testing</h2><p>In GitHub CI and local testing, we can use <a href=https://pre-commit.com rel=external target=_blank title="pre-commit commit hook framework">pre-commit</a> to execute the tests.
It provides a dedicated, clearly defined and always consistent Python environment.
The easiest way to run all tests and checks is to simply run <a href=https://pre-commit.com rel=external target=_blank title="pre-commit commit hook framework">pre-commit</a>.
The example commands below assume that you have Python3 in your PATH.
Currently, Python 3.11 is required for it:</p><div class=tab-panel data-tab-group=edce268087794ada452b6120aaab1125><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=installing-and-running-pre-commit class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("edce268087794ada452b6120aaab1125","installing-and-running-pre-commit")'>
<span class=tab-nav-text>Installing and running pre-commit</span></button></div><div class=tab-content-container><div data-tab-item=installing-and-running-pre-commit class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install pre-commit
</span></span><span style=display:flex><span>pre-commit run -av
</span></span><span style=display:flex><span><span style=color:#75715e># Or, to just run the pytest hook:</span>
</span></span><span style=display:flex><span>pre-commit run -av pytest</span></span></code></pre></div></div></div></div></div><blockquote><p>Note: By default, CentOS 8 provides Python 3.6, whereas some tests need Python >= 3.7</p></blockquote><p>Alternatively, you can of course tests in any suitable environment,
given that you install the supported versions of all dependencies.
You can find the dependencies in the list <a href=https://pre-commit.com/#pre-commit-configyaml---hooks rel=external target=_blank title="dependencies that will be installed in the environment where this hook gets to run">additional_dependencies</a> of the <a href=https://docs.pytest.org rel=external target=_blank title="Pytest documentation">pytest</a> hook
in the <a href=https://pre-commit.com rel=external target=_blank title="pre-commit commit hook framework">pre-commit</a> configuration file <a href=https://pre-commit.com/#adding-pre-commit-plugins-to-your-project rel=external target=_blank title="project-specific configuration file of pre-commit, found in the project's top directory">.pre-commit-config.yaml</a>.<details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
Example <code>pytest</code> hook from <code>.pre-commit-config.yaml</code> (expand)</summary><div class=box-content><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#f92672>hooks</span>:
</span></span><span style=display:flex><span>    -   <span style=color:#f92672>id</span>: <span style=color:#ae81ff>pytest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>files</span>: <span style=color:#ae81ff>python3/</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>check that the Python3 test suite in passes</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>entry</span>: <span style=color:#ae81ff>sh -c &#39;coverage run &amp;&amp; coverage xml &amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>coverage html &amp;&amp; coverage report &amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>diff-cover --ignore-whitespace --compare-branch=origin/master</span>
</span></span><span style=display:flex><span>            --<span style=color:#ae81ff>show-uncovered --format html:.git/coverage-diff.html</span>
</span></span><span style=display:flex><span>            --<span style=color:#ae81ff>fail-under 50 .git/coverage3.11.xml&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>require_serial</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pass_filenames</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>language</span>: <span style=color:#ae81ff>python</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>types</span>: [<span style=color:#ae81ff>python]</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>additional_dependencies</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>coverage</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>diff-cover</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>future</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>opentelemetry-api</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>opentelemetry-exporter-zipkin-json</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>opentelemetry-sdk</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>pytest-mock</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>mock</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>wrapt</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>XenAPI</span></span></span></code></pre></div></div></details></p><h2 id=coverage>Coverage</h2><p>Code moved to the python3 directory tree shall have good code coverage using
tests that are executed, verified and covered using <a href=https://docs.pytest.org rel=external target=_blank title="Pytest documentation">pytest</a> and <a href=https://coverage.readthedocs.io rel=external target=_blank title="coverage.py is the coverage collector for Python">Coverage.py</a>.
The <code>coverage</code> tool and <a href=https://docs.pytest.org rel=external target=_blank title="Pytest documentation">pytest</a> are configured in <code>pyproject.toml</code> and
<code>coverage run</code> is configured to run <a href=https://docs.pytest.org rel=external target=_blank title="Pytest documentation">pytest</a> by default.</p><p><code>coverage run</code> collects coverage from the run and stores it in its database.
The most simple command line to run and report coverage to stdout is:
<code>coverage run && coverage report</code></p><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
Other commands also used in the pytest hook example above (expand)</summary><div class=box-content><ul><li><code>coverage xml</code>: Generates an XML report from the coverage database to
<code>.git/coverage3.11.xml</code>. It is needed for upload to <a href=https://codecov.io rel=external target=_blank>https://codecov.io</a></li><li><code>coverage html</code>: Generates an HTML report from the coverage database to
<code>.git/coverage_html/</code></li></ul></div></details><p>We configure the file paths used for the generated database and other coverage
configuration in the sections <code>[tool.coverage.run]</code> and <code>[tool.coverage.report]</code>
of <code>pyproject.toml</code>.</p><h2 id=pytest>Pytest</h2><p>If your Python environment has the <a href=/new-docs/python/index.html#dependencies-for-development-and-testing title="Installation of the dependencies for development and testing">dependencies for the tests</a> installed, you
can run <a href=https://docs.pytest.org rel=external target=_blank title="Pytest documentation">pytest</a> in this environment without any arguments to use the defaults.</p><details class="box cstyle notices transparent expand"><summary class=box-label><i class="expander-icon fa-fw fas fa-chevron-right"></i>
For development, pytest can also only run one test (expand)</summary><div class=box-content><p>To run a specific pytest command, run pytest and pass the test case to it (example):</p><div class=tab-panel data-tab-group=5b324b0a1f497c32a9cbb2814097139e><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-for-running-only-one-specific-test class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("5b324b0a1f497c32a9cbb2814097139e","example-for-running-only-one-specific-test")'>
<span class=tab-nav-text>Example for running only one specific test</span></button></div><div class=tab-content-container><div data-tab-item=example-for-running-only-one-specific-test class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pytest python3/tests/test_perfmon.py</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=2c1fb8f73069bd960d395372f75e3db0><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=running-only-one-test-and-reporting-the-code-coverage-of-it class="tab-nav-button tab-panel-style cstyle initial active" tabindex=-1 onclick='switchTab("2c1fb8f73069bd960d395372f75e3db0","running-only-one-test-and-reporting-the-code-coverage-of-it")'>
<span class=tab-nav-text>Running only one test and reporting the code coverage of it</span></button></div><div class=tab-content-container><div data-tab-item=running-only-one-test-and-reporting-the-code-coverage-of-it class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="highlight wrap-code"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>coverage run -m pytest python3/tests/test_perfmon.py <span style=color:#f92672>&amp;&amp;</span> coverage report</span></span></code></pre></div></div></div></div></div></div></details><script>for(let e of document.querySelectorAll(".inline-type"))e.innerHTML=renderType(e.innerHTML)</script><footer class=footline></footer></article></div></main></div><script src=/new-docs/js/clipboard.min.js?1764583491 defer></script><script src=/new-docs/js/perfect-scrollbar.min.js?1764583491 defer></script><script src=/new-docs/js/theme.js?1764583491 defer></script><script>function apply_image_invert_filter(e){document.querySelectorAll("img").forEach(function(t){if(t.classList.contains("no-invert"))return;t.style="filter: invert("+e+");"})}function darkThemeUsed(){const t=window.getComputedStyle(document.querySelector("body")),n=t.getPropertyValue("background-color");var e=n.match(/\d+/g).map(function(e){return parseInt(e,10)});return e.length===3&&.2126*e[0]+.7152*e[1]+.0722*e[2]<165}const invertToDarkGray=.85;darkThemeUsed()&&apply_image_invert_filter(invertToDarkGray),document.addEventListener("themeVariantLoaded",function(e){apply_image_invert_filter(e.detail.variant.endsWith("dark")?invertToDarkGray:0)})</script></body></html>