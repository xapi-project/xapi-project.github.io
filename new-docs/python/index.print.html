<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.127.0"><meta name=generator content="Relearn 5.20.0+tip"><meta name=description content><title>Python :: XAPI Toolstack Developer Documentation</title>
<link href=https://xapi-project.github.io/new-docs/python/index.html rel=canonical type=text/html title="Python :: XAPI Toolstack Developer Documentation"><link href=/new-docs/python/index.xml rel=alternate type=application/rss+xml title="Python :: XAPI Toolstack Developer Documentation"><link href=/new-docs/images/favicon.png?1725538167 rel=icon type=image/png><link href=/new-docs/css/fontawesome-all.min.css?1725538172 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fontawesome-all.min.css?1725538172 rel=stylesheet></noscript><link href=/new-docs/css/nucleus.css?1725538172 rel=stylesheet><link href=/new-docs/css/auto-complete.css?1725538172 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/auto-complete.css?1725538172 rel=stylesheet></noscript><link href=/new-docs/css/perfect-scrollbar.min.css?1725538172 rel=stylesheet><link href=/new-docs/css/fonts.css?1725538172 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fonts.css?1725538172 rel=stylesheet></noscript><link href=/new-docs/css/theme.css?1725538172 rel=stylesheet><link href=/new-docs/css/theme-auto.css?1725538172 rel=stylesheet id=variant-style><link href=/new-docs/css/variant.css?1725538172 rel=stylesheet><link href=/new-docs/css/print.css?1725538172 rel=stylesheet media=print><link href=/new-docs/css/format-print.css?1725538172 rel=stylesheet><link href=/new-docs/css/ie.css?1725538172 rel=stylesheet><script src=/new-docs/js/url.js?1725538172></script><script src=/new-docs/js/variant.js?1725538172></script><script>window.index_js_url="/new-docs/index.search.js";var baseUriFull,root_url="/",baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found='No results found for "{0}"',window.T_N_results_found='{1} results found for "{0}"',baseUriFull="https://xapi-project.github.io/new-docs/",window.variants&&variants.init(["auto","zen-light","zen-dark","red","blue","green","learn","neon","relearn-light","relearn-bright","relearn-dark"])</script><link rel=stylesheet href=https://xapi-project.github.io/new-docs/css/misc.css></head><body class="mobile-support print" data-url=/new-docs/python/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/index.html><span itemprop=name>XAPI Toolstack Developer Guide</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Python</span><meta itemprop=position content="2"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=python>Python</h1><h2 id=introduction>Introduction</h2><p>Most Python3 scripts and plugins shall be located below the <code>python3</code> directory.
The structure of the directory is as follows:</p><ul><li><code>python3/bin</code>: This contains files installed in <code>/opt/xensource/bin</code>
and are meant to be run by users</li><li><code>python3/libexec</code>: This contains files installed in <code>/opt/xensource/libexec</code>
and are meant to only be run by <code>xapi</code> and other daemons.</li><li><code>python3/packages</code>: Contains files to be installed in python&rsquo;s <code>site-packages</code>
are meant to be modules and packages to be imported by other scripts
or executed via <code>python3 -m</code></li><li><code>python3/plugins</code>: This contains files that
are meant to be <code>xapi</code> plugins</li><li><code>python3/tests</code>: Tests for testing and covering the Python scripts and plugins</li></ul><h2 id=dependencies-for-development-and-testing>Dependencies for development and testing</h2><p>In GitHub CI and local testing, we can use <a href=https://pre-commit.com title="pre-commit commit hook framework" target=_blank>pre-commit</a> to execute the tests.
It provides a dedicated, clearly defined and always consistent Python environment.
The easiest way to run all tests and checks is to simply run <a href=https://pre-commit.com title="pre-commit commit hook framework" target=_blank>pre-commit</a>.
The example commands below assume that you have Python3 in your PATH.
Currently, Python 3.11 is required for it:</p><div class=tab-panel data-tab-group=7edf0bb1dcf8b6ed05999e90a805c972><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=installing-and-running-pre-commit class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("7edf0bb1dcf8b6ed05999e90a805c972","installing-and-running-pre-commit")'><div><div class=tab-nav-hidden>Installing and running pre-commit</div><div class=tab-nav-text>Installing and running pre-commit</div></div></button></div><div class=tab-content-container><div data-tab-item=installing-and-running-pre-commit class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip3 install pre-commit
</span></span><span style=display:flex><span>pre-commit run -av
</span></span><span style=display:flex><span><span style=color:#75715e># Or, to just run the pytest hook:</span>
</span></span><span style=display:flex><span>pre-commit run -av pytest</span></span></code></pre></div></div></div></div></div><blockquote><p>Note: By default, CentOS 8 provides Python 3.6, whereas some tests need Python >= 3.7</p></blockquote><p>Alternatively, you can of course tests in any suitable environment,
given that you install the supported versions of all dependencies.
You can find the dependencies in the list <a href=https://pre-commit.com/#pre-commit-configyaml---hooks title="dependencies that will be installed in the environment where this hook gets to run" target=_blank>additional_dependencies</a> of the <a href=https://docs.pytest.org title="Pytest documentation" target=_blank>pytest</a> hook
in the <a href=https://pre-commit.com title="pre-commit commit hook framework" target=_blank>pre-commit</a> configuration file <a href=https://pre-commit.com/#adding-pre-commit-plugins-to-your-project title="project-specific configuration file of pre-commit, found in the project's top directory" target=_blank>.pre-commit-config.yaml</a>.<div class=expand><input type=checkbox id=expand-0ceeea68f7c17f0f5be998dddb311d65 aria-controls=expandcontent-0ceeea68f7c17f0f5be998dddb311d65>
<label class=expand-label for=expand-0ceeea68f7c17f0f5be998dddb311d65><i class="fas fa-chevron-down"></i>
<i class="fas fa-chevron-right"></i>
Example <code>pytest</code> hook from <code>.pre-commit-config.yaml</code> (expand)</label><div id=expandcontent-0ceeea68f7c17f0f5be998dddb311d65 class=expand-content><div class="wrap-code highlight"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#f92672>hooks</span>:
</span></span><span style=display:flex><span>    -   <span style=color:#f92672>id</span>: <span style=color:#ae81ff>pytest</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>files</span>: <span style=color:#ae81ff>python3/</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>check that the Python3 test suite in passes</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>entry</span>: <span style=color:#ae81ff>sh -c &#39;coverage run &amp;&amp; coverage xml &amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>coverage html &amp;&amp; coverage report &amp;&amp;</span>
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>diff-cover --ignore-whitespace --compare-branch=origin/master</span>
</span></span><span style=display:flex><span>            --<span style=color:#ae81ff>show-uncovered --html-report .git/coverage-diff.html</span>
</span></span><span style=display:flex><span>            --<span style=color:#ae81ff>fail-under 50 .git/coverage3.11.xml&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>require_serial</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pass_filenames</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>language</span>: <span style=color:#ae81ff>python</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>types</span>: [<span style=color:#ae81ff>python]</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>additional_dependencies</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>coverage</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>diff-cover</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>future</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>opentelemetry-api</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>opentelemetry-exporter-zipkin-json</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>opentelemetry-sdk</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>pytest-mock</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>mock</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>wrapt</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>XenAPI</span></span></span></code></pre></div></div></div></p><h2 id=coverage>Coverage</h2><p>Code moved to the python3 directory tree shall have good code coverage using
tests that are executed, verified and covered using <a href=https://docs.pytest.org title="Pytest documentation" target=_blank>pytest</a> and <a href=https://coverage.readthedocs.io title="coverage.py is the coverage collector for Python" target=_blank>Coverage.py</a>.
The <code>coverage</code> tool and <a href=https://docs.pytest.org title="Pytest documentation" target=_blank>pytest</a> are configured in <code>pyproject.toml</code> and
<code>coverage run</code> is configured to run <a href=https://docs.pytest.org title="Pytest documentation" target=_blank>pytest</a> by default.</p><p><code>coverage run</code> collects coverage from the run and stores it in its database.
The most simple command line to run and report coverage to stdout is:
<code>coverage run && coverage report</code></p><div class=expand><input type=checkbox id=expand-d8e30fff1bb0d922f9200c75aab477a7 aria-controls=expandcontent-d8e30fff1bb0d922f9200c75aab477a7>
<label class=expand-label for=expand-d8e30fff1bb0d922f9200c75aab477a7><i class="fas fa-chevron-down"></i>
<i class="fas fa-chevron-right"></i>
Other commands also used in the pytest hook example above (expand)</label><div id=expandcontent-d8e30fff1bb0d922f9200c75aab477a7 class=expand-content><ul><li><code>coverage xml</code>: Generates an XML report from the coverage database to
<code>.git/coverage3.11.xml</code>. It is needed for upload to <a href=https://codecov.io target=_blank>https://codecov.io</a></li><li><code>coverage html</code>: Generates an HTML report from the coverage database to
<code>.git/coverage_html/</code></li></ul></div></div><p>We configure the file paths used for the generated database and other coverage
configuration in the sections <code>[tool.coverage.run]</code> and <code>[tool.coverage.report]</code>
of <code>pyproject.toml</code>.</p><h2 id=pytest>Pytest</h2><p>If your Python environment has the <a href=#dependencies-for-development-and-testing title="Installation of the dependencies for development and testing">dependencies for the tests</a> installed, you
can run <a href=https://docs.pytest.org title="Pytest documentation" target=_blank>pytest</a> in this environment without any arguments to use the defaults.</p><div class=expand><input type=checkbox id=expand-5470129d28aea52db5f5ee4a188a1065 aria-controls=expandcontent-5470129d28aea52db5f5ee4a188a1065>
<label class=expand-label for=expand-5470129d28aea52db5f5ee4a188a1065><i class="fas fa-chevron-down"></i>
<i class="fas fa-chevron-right"></i>
For development, pytest can also only run one test (expand)</label><div id=expandcontent-5470129d28aea52db5f5ee4a188a1065 class=expand-content><p>To run a specific pytest command, run pytest and pass the test case to it (example):</p><div class=tab-panel data-tab-group=059b22a1ee2f8270b35cf572e916eafc><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=example-for-running-only-one-specific-test class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("059b22a1ee2f8270b35cf572e916eafc","example-for-running-only-one-specific-test")'><div><div class=tab-nav-hidden>Example for running only one specific test</div><div class=tab-nav-text>Example for running only one specific test</div></div></button></div><div class=tab-content-container><div data-tab-item=example-for-running-only-one-specific-test class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pytest python3/tests/test_perfmon.py</span></span></code></pre></div></div></div></div></div><div class=tab-panel data-tab-group=796488dbfd2b14ecd41af680f3acc8c8><div class=tab-nav><div class=tab-nav-title>&#8203;</div><button data-tab-item=running-only-one-test-and-reporting-the-code-coverage-of-it class="tab-nav-button tab-panel-style cstyle initial active" onclick='switchTab("796488dbfd2b14ecd41af680f3acc8c8","running-only-one-test-and-reporting-the-code-coverage-of-it")'><div><div class=tab-nav-hidden>Running only one test and reporting the code coverage of it</div><div class=tab-nav-text>Running only one test and reporting the code coverage of it</div></div></button></div><div class=tab-content-container><div data-tab-item=running-only-one-test-and-reporting-the-code-coverage-of-it class="tab-content tab-panel-style cstyle initial active"><div class=tab-content-text><div class="wrap-code highlight"><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>coverage run -m pytest python3/tests/test_perfmon.py <span style=color:#f92672>&amp;&amp;</span> coverage report</span></span></code></pre></div></div></div></div></div></div></div><footer class=footline></footer></article></div></main></div><script src=/new-docs/js/clipboard.min.js?1725538172 defer></script><script src=/new-docs/js/perfect-scrollbar.min.js?1725538172 defer></script><script src=/new-docs/js/theme.js?1725538172 defer></script></body></html>