<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.127.0"><meta name=generator content="Relearn 5.20.0+tip"><meta name=description content><title>High-level architecture :: XAPI Toolstack Developer Documentation</title>
<link href=https://xapi-project.github.io/new-docs/toolstack/high-level/index.html rel=canonical type=text/html title="High-level architecture :: XAPI Toolstack Developer Documentation"><link href=/new-docs/toolstack/high-level/index.xml rel=alternate type=application/rss+xml title="High-level architecture :: XAPI Toolstack Developer Documentation"><link href=/new-docs/images/favicon.png?1737044738 rel=icon type=image/png><link href=/new-docs/css/fontawesome-all.min.css?1737044742 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fontawesome-all.min.css?1737044742 rel=stylesheet></noscript><link href=/new-docs/css/nucleus.css?1737044742 rel=stylesheet><link href=/new-docs/css/auto-complete.css?1737044742 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/auto-complete.css?1737044742 rel=stylesheet></noscript><link href=/new-docs/css/perfect-scrollbar.min.css?1737044742 rel=stylesheet><link href=/new-docs/css/fonts.css?1737044742 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fonts.css?1737044742 rel=stylesheet></noscript><link href=/new-docs/css/theme.css?1737044742 rel=stylesheet><link href=/new-docs/css/theme-auto.css?1737044742 rel=stylesheet id=variant-style><link href=/new-docs/css/variant.css?1737044742 rel=stylesheet><link href=/new-docs/css/print.css?1737044742 rel=stylesheet media=print><link href=/new-docs/css/format-print.css?1737044742 rel=stylesheet><link href=/new-docs/css/ie.css?1737044742 rel=stylesheet><script src=/new-docs/js/url.js?1737044742></script><script src=/new-docs/js/variant.js?1737044742></script><script>window.index_js_url="/new-docs/index.search.js";var baseUriFull,root_url="/",baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found='No results found for "{0}"',window.T_N_results_found='{1} results found for "{0}"',baseUriFull="https://xapi-project.github.io/new-docs/",window.variants&&variants.init(["auto","zen-light","zen-dark","red","blue","green","learn","neon","relearn-light","relearn-bright","relearn-dark"])</script><link rel=stylesheet href=https://xapi-project.github.io/new-docs/css/misc.css></head><body class="mobile-support print" data-url=/new-docs/toolstack/high-level/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/index.html><span itemprop=name>XAPI Toolstack Developer Guide</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/toolstack/index.html><span itemprop=name>The XAPI Toolstack</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>High-level architecture</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=high-level-architecture>High-level architecture</h1><p>The XAPI Toolstack manages a cluster of hosts, network switches and storage on
behalf of clients such as <a href=https://github.com/xenserver/xenadmin target=_blank>XenCenter</a>
and <a href=https://xen-orchestra.com target=_blank>Xen Orchestra</a>.</p><p>The most fundamental concept is of a <em>Resource pool</em>: the whole cluster managed
as a single entity. The following diagram shows a cluster of hosts running
xapi, all sharing some storage:</p><p><a href=#image-c48cd1eff569a91d4a880cc83455e54a class=lightbox-link><img src=/new-docs/toolstack/high-level/pool.png alt="A Resource Pool" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=image-c48cd1eff569a91d4a880cc83455e54a><img src=/new-docs/toolstack/high-level/pool.png alt="A Resource Pool" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>At any time, at most one host is known as the <em>pool coordinator</em> (formerly
known as &ldquo;master&rdquo;) and is responsible for coordination and locking resources
within the pool. When a pool is first created a coordinator host is chosen. The
coordinator role can be transferred</p><ul><li>on user request in an orderly fashion (<code>xe pool-designate-new-master</code>)</li><li>on user request in an emergency (<code>xe pool-emergency-transition-to-master</code>)</li><li>automatically if HA is enabled on the cluster.</li></ul><p>All hosts expose an HTTP, XML-RPC and JSON-RPC interface running on port 80 and
with TLS on port 443, but control operations will only be processed on the
coordinator host. Attempts to send a control operation to another host will
result in a XenAPI redirect error message. For efficiency the following
operations are permitted on non-coordinator hosts:</p><ul><li>querying performance counters (and their history)</li><li>connecting to VNC consoles</li><li>import/export (particularly when disks are on local storage)</li></ul><p>Since the coordinator host acts as coordinator and lock manager, the other
hosts will often talk to the coordinator. Non-coordinator hosts will also talk
to each other (over the same HTTP and RPC channels) to</p><ul><li>transfer VM memory images (<em>VM migration</em>)</li><li>mirror disks (<em>storage migration</em>)</li></ul><p>Note that some types of shared storage (in particular all those using vhd)
require coordination for disk GC and coalesce. This coordination is currently
done by xapi and hence it is not possible to share this kind of storage between
resource pools.</p><p>The following diagram shows the software running on a single host. Note that
all hosts run the same software (although not necessarily the same version, if
we are in the middle of a rolling update).</p><p><a href=#image-9ad7dad258ab2e430b8a97c6b57cfa4b class=lightbox-link><img src=/new-docs/toolstack/high-level/host.png alt="A Host" class="figure-image noborder lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=image-9ad7dad258ab2e430b8a97c6b57cfa4b><img src=/new-docs/toolstack/high-level/host.png alt="A Host" class="lightbox-image noborder lightbox noshadow" loading=lazy></a></p><p>The XAPI Toolstack expects the host to be running Xen on x86. The Xen
hypervisor partitions the host into <em>Domains</em>, some of which can have
privileged hardware access, and the rest are unprivileged guests. The XAPI
Toolstack normally runs all of its components in the privileged initial domain,
Domain 0, also known as &ldquo;the control domain&rdquo;. However there is experimental
code which supports &ldquo;driver domains&rdquo; allowing storage and networking drivers to
be isolated in their own domains.</p><ul class="children children-li children-sort-"><li><a href=/new-docs/toolstack/high-level/environment/index.html>Environment</a><ul></ul></li><li><a href=/new-docs/toolstack/high-level/daemons/index.html>Daemons</a><ul></ul></li><li><a href=/new-docs/toolstack/high-level/interfaces/index.html>Interfaces</a><ul></ul></li></ul><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of High-level architecture</h1><article class=default><header class=headline></header><h1 id=environment>Environment</h1><p>The Toolstack runs in an environment on a server (host) that has:</p><ul><li>Physical hardware.</li><li>The Xen hypervisor.</li><li>The control domain (domain 0): the priviledged domain that the Toolstack runs in.</li><li>Other, mostly unpriviledged domains, usually for guests (VMs).</li></ul><p>The Toolstack relies on various bits of software inside the control domain, and directly communicates with most of these:</p><ul><li>Linux kernel including drivers for hardware and Xen paravirtualised devices (e.g. <code>netback</code> and <code>blkback</code>).<ul><li>Interacts through <code>/sys</code> and <code>/proc</code>, udev scripts, xenstore, &mldr;</li></ul></li><li>CentOS distibution including userspace tools and libraries.<ul><li>systemd, networking tools, &mldr;</li></ul></li><li>Xen-specific libraries, especially <code>libxenctrl</code> (a.k.a. <code>libxc</code>)</li><li><code>xenstored</code>: a key-value pair configuration database<ul><li>Accessible from all domains on a host, which makes it useful for inter-domain communication.</li><li>The control domain has access to the entire xenstore database, while other domains only see sub-trees that are specific to that domain.</li><li>Used for connecting VM disks and network interfaces, and other VM configuration options.</li><li>Used for VM status reporting, e.g. the capabilities of the PV drivers (if installed), the IP address, etc.</li></ul></li><li><a href=https://github.com/xapi-project/sm target=_blank>SM</a>: Storage Manager
plugins which connect xapi&rsquo;s internal storage interfaces to the control
APIs of external storage systems.</li><li><code>stunnel</code>: a daemon which decodes TLS and forwards traffic to xapi (and the other way around).</li><li>Open vSwitch (OVS): a virtual network switch, used to connect VMs to network interfaces. The OVS offers several networking features that xapi takes advantage of.</li><li>QEMU: emulation of various bits of hardware</li><li>DEMU: emulation of Nvidia vGPUs</li><li><code>xenguest</code></li><li><code>emu-manager</code></li><li><code>pvsproxy</code></li><li><code>xenconsoled</code>: allows access to guest consoles. This is common to all Xen
hosts.</li></ul><p>The Toolstack also interacts with software that runs inside the guests:</p><ul><li>PV drivers</li><li>The guest agent</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=daemons>Daemons</h1><p>The Toolstack consists of a set of co-operating daemons:</p><dl><dt>xapi</dt><dd>manages clusters of hosts, co-ordinating access to shared storage and networking.</dd><dt>xenopsd</dt><dd>a low-level &ldquo;domain manager&rdquo; which takes care of creating, suspending,
resuming, migrating, rebooting domains by interacting with Xen via libxc and
libxl.</dd><dt>xcp-rrdd</dt><dd>a performance counter monitoring daemon which aggregates &ldquo;datasources&rdquo; defined
via a plugin API and records history for each. There are various rrdd-plugin daemons:<ul><li>xcp-rrdd-gpumon</li><li>xcp-rrdd-iostat</li><li>xcp-rrdd-squeezed</li><li>xcp-rrdd-xenpm</li><li>xcp-rrdd-dcmi</li><li>xcp-rrdd-netdev</li><li>xcp-rrdd-cpu</li></ul></dd><dt>xcp-networkd</dt><dd>a host network manager which takes care of configuring interfaces, bridges
and OpenVSwitch instances</dd><dt>squeezed</dt><dd>a daemon in charge of VM memory management</dd><dt>xapi-storage-script</dt><dd>for storage manipulation over SMAPIv3</dd><dt>message-switch</dt><dd>exchanges messages between the daemons on a host</dd><dt>xapi-guard</dt><dd>forwards uefi and vtpm persistence calls from domains to xapi</dd><dt>v6d</dt><dd>controls which features are enabled.</dd><dt>forkexecd</dt><dd>a helper daemon that assists the above daemons with executing binaries and scripts</dd><dt>xhad</dt><dd>The High-Availability daemon</dd><dt>perfmon</dt><dd>a daemon which monitors performance counters and sends &ldquo;alerts&rdquo;
if values exceed some pre-defined threshold</dd><dt>mpathalert</dt><dd>a daemon which monitors &ldquo;storage paths&rdquo; and sends &ldquo;alerts&rdquo;
if paths fail and need repair</dd><dt>wsproxy</dt><dd>handles access to VM consoles</dd></dl><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=interfaces>Interfaces</h1><p>Communication between the Toolstack daemon is built upon libraries from a
component called
<a href=https://github.com/xapi-project/xen-api/tree/master/ocaml/xapi-idl target=_blank>xapi-idl</a>.</p><ul><li>Abstracts communication between daemons over the message-switch using JSON/RPC.</li><li>Contains the definition of the interfaces exposed by the daemons (except xapi).</li></ul><footer class=footline></footer></article></section></div></main></div><script src=/new-docs/js/clipboard.min.js?1737044742 defer></script><script src=/new-docs/js/perfect-scrollbar.min.js?1737044742 defer></script><script src=/new-docs/js/theme.js?1737044742 defer></script></body></html>