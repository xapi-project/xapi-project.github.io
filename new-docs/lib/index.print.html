<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.127.0"><meta name=generator content="Relearn 7.3.2"><meta name=description content="libxenctrlXen Control library for controlling the Xen hypervisor"><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Libraries :: XAPI Toolstack Developer Documentation"><meta name=twitter:description content="libxenctrlXen Control library for controlling the Xen hypervisor"><meta property="og:url" content="https://xapi-project.github.io/new-docs/lib/index.html"><meta property="og:site_name" content="XAPI Toolstack Developer Documentation"><meta property="og:title" content="Libraries :: XAPI Toolstack Developer Documentation"><meta property="og:description" content="libxenctrlXen Control library for controlling the Xen hypervisor"><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Libraries :: XAPI Toolstack Developer Documentation"><meta itemprop=description content="libxenctrlXen Control library for controlling the Xen hypervisor"><meta itemprop=wordCount content="8"><title>Libraries :: XAPI Toolstack Developer Documentation</title>
<link href=https://xapi-project.github.io/new-docs/lib/index.html rel=canonical type=text/html title="Libraries :: XAPI Toolstack Developer Documentation"><link href=/new-docs/lib/index.xml rel=alternate type=application/rss+xml title="Libraries :: XAPI Toolstack Developer Documentation"><link href=/new-docs/images/favicon.png?1741279370 rel=icon type=image/png><link href=/new-docs/css/fontawesome-all.min.css?1741279370 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fontawesome-all.min.css?1741279370 rel=stylesheet></noscript><link href=/new-docs/css/auto-complete.css?1741279370 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/auto-complete.css?1741279370 rel=stylesheet></noscript><link href=/new-docs/css/perfect-scrollbar.min.css?1741279370 rel=stylesheet><link href=/new-docs/css/theme.min.css?1741279370 rel=stylesheet><link href=/new-docs/css/format-print.min.css?1741279370 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://xapi-project.github.io/new-docs",window.relearn.min=`.min`,window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.themevariants=["auto","zen-light","zen-dark","red","blue","green","learn","neon","relearn-light","relearn-bright","relearn-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}}))},window.relearn.markVariant=function(){var t=window.localStorage.getItem(window.relearn.absBaseUri+"/variant"),e=document.querySelector("#R-select-variant");e&&(e.value=t)},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant(),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link rel=stylesheet href=https://xapi-project.github.io/new-docs/css/misc.css></head><body class="mobile-support print" data-url=/new-docs/lib/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/index.html><span itemprop=name>XAPI Toolstack Developer Guide</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Libraries</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-edit" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=https://github.com/xapi-project/xen-api/edit/master/doc/content/lib/_index.md target=_blank title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a></div><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/lib/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/design/xenprep/index.html title="XenPrep (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/lib/xenctrl/index.html title="libxenctrl (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable lib" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=libraries>Libraries</h1><ul class="children children-li children-sort-"><li><a href=/new-docs/lib/xenctrl/index.html>libxenctrl</a><p>Xen Control library for controlling the Xen hypervisor</p></li></ul><script>for(let e of document.querySelectorAll(".inline-type"))e.innerHTML=renderType(e.innerHTML)</script><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Libraries</h1><article class=default><header class=headline></header><h1 id=libxenctrl>libxenctrl</h1><ul class="children children-li children-sort-"><li><a href=/new-docs/lib/xenctrl/xc_domain_node_setaffinity/index.html>xc_domain_node_setaffinity()</a><p>Set a Xen domain's NUMA node affinity</p></li></ul><script>for(let e of document.querySelectorAll(".inline-type"))e.innerHTML=renderType(e.innerHTML)</script><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of libxenctrl</h1><article class=default><header class=headline></header><h1 id=xc_domain_node_setaffinity>xc_domain_node_setaffinity()</h1><p><code>xc_domain_node_setaffinity()</code> controls the NUMA node affinity of a domain.</p><p>By default, Xen enables the <code>auto_node_affinity</code> feature flag,
where setting the vCPU affinity also sets the NUMA node affinity for
memory allocations to be aligned with the vCPU affinity of the domain.</p><p>Setting the NUMA node affinity using this call can be used,
for example, when there might not be enough memory on the
preferred NUMA node, but there are other NUMA nodes that have
enough free memory to be used for the system memory of the domain.</p><p>In terms of future NUMA design, it might be even more favourable to
have a strategy in <code>xenguest</code> where in such cases, the superpages
of the preferred node are used first and a fallback to neighbouring
NUMA nodes only happens to the extent necessary.</p><p>Likely, the future allocation strategy should be passed to <code>xenguest</code>
using Xenstore like the other platform parameters for the VM.</p><h2 id=walk-through-of-xc_domain_node_setaffinity>Walk-through of xc_domain_node_setaffinity()</h2><pre class="mermaid align-center">classDiagram
class `xc_domain_node_setaffinity()` {
    +xch: xc_interface #42;
    +domid: uint32_t
    +nodemap: xc_nodemap_t
    0(on success)
    -EINVAL(if a node in the nodemask is not online)
}
click `xc_domain_node_setaffinity()` href &#34;
https://github.com/xen-project/xen/blob/master/tools/libs/ctrl/xc_domain.c#L122-L158&#34;

`xc_domain_node_setaffinity()` --&gt; `Xen hypercall: do_domctl()`
`xc_domain_node_setaffinity()` &lt;-- `Xen hypercall: do_domctl()`
class `Xen hypercall: do_domctl()` {
    Calls domain_set_node_affinity#40;#41; and returns its return value
    Passes: domain (struct domain *, looked up using the domid)
    Passes: new_affinity (modemask, converted from xc_nodemap_t)
}
click `Xen hypercall: do_domctl()` href &#34;
https://github.com/xen-project/xen/blob/master/xen/common/domctl.c#L516-L525&#34;

`Xen hypercall: do_domctl()` --&gt; `domain_set_node_affinity()`
`Xen hypercall: do_domctl()` &lt;-- `domain_set_node_affinity()`
class `domain_set_node_affinity()` {
    domain: struct domain
    new_affinity: nodemask
    0(on success, the domain&#39;s node_affinity is updated)
    -EINVAL(if a node in the nodemask is not online)
}
click `domain_set_node_affinity()` href &#34;
https://github.com/xen-project/xen/blob/master/xen/common/domain.c#L943-L970&#34;</pre><h3 id=domain_set_node_affinity>domain_set_node_affinity()</h3><p>This function implements the functionality of <code>xc_domain_node_setaffinity</code>
to set the NUMA affinity of a domain as described above.
If the new_affinity does not intersect the <code>node_online_map</code>,
it returns <code>-EINVAL</code>, otherwise on success <code>0</code>.</p><p>When the <code>new_affinity</code> is a specific set of NUMA nodes, it updates the NUMA
<code>node_affinity</code> of the domain to these nodes and disables <code>auto_node_affinity</code>
for this domain. It also notifies the Xen scheduler of the change.</p><p>This sets the preference the memory allocator to the new NUMA nodes,
and in theory, it could also alter the behaviour of the scheduler.
This of course depends on the scheduler and its configuration.</p><h2 id=notes-on-future-design-improvements>Notes on future design improvements</h2><p>This call cannot influence the past: The <code>xenopsd</code>
<a href=/new-docs/xenopsd/walkthroughs/VM.start/index.html#2-create-a-xen-domain>VM_create</a>
micro-ops calls <code>Xenctrl.domain_create</code>. It currently creates
the domain&rsquo;s data structures before <code>numa_placement</code> was done.</p><p>Improving <code>Xenctrl.domain_create</code> to pass a NUMA node
for allocating the Hypervisor&rsquo;s data structures (e.g. vCPU)
of the domain would require changes
to the Xen hypervisor and the <code>xenopsd</code>
<a href=/new-docs/xenopsd/walkthroughs/VM.start/index.html#2-create-a-xen-domain>xenopsd VM_create</a>
micro-op.</p><script>for(let e of document.querySelectorAll(".inline-type"))e.innerHTML=renderType(e.innerHTML)</script><footer class=footline></footer></article></section></section></div></main></div><script src=/new-docs/js/clipboard.min.js?1741279370 defer></script><script src=/new-docs/js/perfect-scrollbar.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-color.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-dispatch.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-drag.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-ease.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-interpolate.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-selection.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-timer.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-transition.min.js?1741279370 defer></script><script src=/new-docs/js/d3/d3-zoom.min.js?1741279370 defer></script><script src=/new-docs/js/js-yaml.min.js?1741279370 defer></script><script src=/new-docs/js/mermaid.min.js?1741279370 defer></script><script>window.themeUseMermaid=JSON.parse('{ "fontFamily": "Roboto Flex", "securityLevel": "loose" }')</script><script src=/new-docs/js/theme.js?1741279370 defer></script><script>function apply_image_invert_filter(e){document.querySelectorAll("img").forEach(function(t){if(t.classList.contains("no-invert"))return;t.style="filter: invert("+e+");"})}function darkThemeUsed(){const t=window.getComputedStyle(document.querySelector("body")),n=t.getPropertyValue("background-color");var e=n.match(/\d+/g).map(function(e){return parseInt(e,10)});return e.length===3&&.2126*e[0]+.7152*e[1]+.0722*e[2]<165}const invertToDarkGray=.85;darkThemeUsed()&&apply_image_invert_filter(invertToDarkGray),document.addEventListener("themeVariantLoaded",function(e){apply_image_invert_filter(e.detail.variant.endsWith("dark")?invertToDarkGray:0)})</script></body></html>