<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.119.0"><meta name=generator content="Relearn 5.20.0+tip"><meta name=description content><title>Adding a field to the API :: XAPI Toolstack Developer Documentation</title><link href=/new-docs/images/favicon.png?1697450080 rel=icon type=image/png><link href=/new-docs/css/fontawesome-all.min.css?1697450080 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fontawesome-all.min.css?1697450080 rel=stylesheet></noscript><link href=/new-docs/css/nucleus.css?1697450080 rel=stylesheet><link href=/new-docs/css/auto-complete.css?1697450080 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/auto-complete.css?1697450080 rel=stylesheet></noscript><link href=/new-docs/css/perfect-scrollbar.min.css?1697450080 rel=stylesheet><link href=/new-docs/css/fonts.css?1697450080 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fonts.css?1697450080 rel=stylesheet></noscript><link href=/new-docs/css/theme.css?1697450080 rel=stylesheet><link href=/new-docs/css/theme-red.css?1697450080 rel=stylesheet id=variant-style><link href=/new-docs/css/variant.css?1697450080 rel=stylesheet><link href=/new-docs/css/print.css?1697450080 rel=stylesheet media=print><link href=/new-docs/css/ie.css?1697450080 rel=stylesheet><script src=/new-docs/js/url.js?1697450080></script>
<script src=/new-docs/js/variant.js?1697450080></script>
<script>window.index_js_url="/new-docs/index.search.js";var root_url="/",baseUriFull,baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found="No results found for \"{0}\"",window.T_N_results_found="{1} results found for \"{0}\"",baseUriFull="https://xapi-project.github.io/new-docs/",window.variants&&variants.init(["red"])</script></head><body class="mobile-support html" data-url=/new-docs/xapi/guides/howtos/add-field/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div class=navigation><a class="nav nav-next topbar-link" href=/new-docs/xapi/guides/howtos/add-function/index.html title="Adding a function to the API (&#129106;)"><i class="fas fa-chevron-right fa-fw"></i></a></div><div class=navigation><a class="nav nav-prev topbar-link" href=/new-docs/xapi/guides/howtos/add-class/index.html title="Adding a Class to the API (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span>
<span id=toc-menu title='Table of Contents (CTRL+ALT+t)'><i class="fas fa-list-alt fa-fw"></i></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/index.html><span itemprop=name>XAPI Toolstack Developer Guide</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/xapi/index.html><span itemprop=name>Xapi</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/xapi/guides/index.html><span itemprop=name>Guides</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/xapi/guides/howtos/index.html><span itemprop=name>How to add....</span></a><meta itemprop=position content="4">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Adding a field to the API</span><meta itemprop=position content="5"></li></ol></div><div class="default-animation progress"><div class=toc-wrapper><nav id=TableOfContents><ul><li><a href=#bumping-the-database-schema-version>Bumping the database schema version</a><ul><li><a href=#setting-the-schema-hash>Setting the schema hash</a></li></ul></li><li><a href=#adding-the-new-field-to-some-existing-class>Adding the new field to some existing class</a><ul><li><a href=#ocamlidldatamodelml>ocaml/idl/datamodel.ml</a></li></ul></li><li><a href=#changing-constructors>Changing Constructors</a><ul><li><a href=#cli-records>CLI Records</a></li></ul></li><li><a href=#testing>Testing</a></li><li><a href=#making-this-field-accessible-as-a-cli-attribute>Making this field accessible as a CLI attribute</a></li></ul></nav></div></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=adding-a-field-to-the-api>Adding a field to the API</h1><p>This page describes how to add a field to XenAPI. A field is a parameter of a class that can be used in functions and read from the API.</p><h2 id=bumping-the-database-schema-version>Bumping the database schema version</h2><p>Whenever a field is added to or removed from the API, its schema version needs
to be increased. XAPI needs this fundamental procedure in order to be able to
detect that an automatic database upgrade is necessary or to find out that the
new schema is incompatible with the existing database. If the schema version is
not bumped, XAPI will start failing in unpredictable ways. Note that bumping
the version is not necessary when adding functions, only when adding fields.</p><p>The current version number is kept at the top of the file
<code>ocaml/idl/datamodel_common.ml</code> in the variables <code>schema_major_vsn</code> and
<code>schema_minor_vsn</code>, of which only the latter should be incremented (the major
version only exists for historical reasons). When moving to a new XenServer
release, also update the variable <code>last_release_schema_minor_vsn</code> to the schema
version of the last release. To keep track of the schema versions of recent
XenServer releases, the file contains variables for these, such as
<code>miami_release_schema_minor_vsn</code>. After starting a new version of Xapi on an
existing server, the database is automatically upgraded if the schema version
of the existing database matches the value of <code>last_release_schema_*_vsn</code> in the
new Xapi.</p><p>As an example, the patch below shows how the schema version was bumped when the
new API fields used for ActiveDirectory integration were added:</p><pre><code>--- a/ocaml/idl/datamodel.ml  Tue Nov 11 16:17:48 2008 +0000
+++ b/ocaml/idl/datamodel.ml  Tue Nov 11 15:53:29 2008 +0000
@@ -15,17 +15,20 @@ open Datamodel_types
  open Datamodel_types

  (* IMPORTANT: Please bump schema vsn if you change/add/remove a _field_.
     You do not have to dump vsn if you change/add/remove a message *)

  let schema_major_vsn = 5
 -let schema_minor_vsn = 55
 +let schema_minor_vsn = 56

  (* Historical schema versions just in case this is useful later *)
  let rio_schema_major_vsn = 5
  let rio_schema_minor_vsn = 19

 +let miami_release_schema_major_vsn = 5
 +let miami_release_schema_minor_vsn = 35
 +
  (* the schema vsn of the last release: used to determine whether we can
     upgrade or not.. *)
  let last_release_schema_major_vsn = 5
 -let last_release_schema_minor_vsn = 35
 +let last_release_schema_minor_vsn = 55
</code></pre><h3 id=setting-the-schema-hash>Setting the schema hash</h3><p>In the <code>ocaml/idl/schematest.ml</code> there is the <code>last_known_schema_hash</code> This needs to be updated to be the next hash after the schema version was bumped. Get the new hash by running <code>make test</code> and you will receive the correct hash in the error message.</p><h2 id=adding-the-new-field-to-some-existing-class>Adding the new field to some existing class</h2><h3 id=ocamlidldatamodelml>ocaml/idl/datamodel.ml</h3><p>Add a new &ldquo;field&rdquo; line to the class in the file <code>ocaml/idl/datamodel.ml</code> or <code>ocaml/idl/datamodel_[class].ml</code>. The new field might require
a suitable default value. This default value is used in case the user does not
provide a value for the field.</p><p>A field has a number of parameters:</p><ul><li>The lifecycle parameter, which shows how the field has evolved over time.</li><li>The qualifier parameter, which controls access to the field. The following
values are possible:</li></ul><table><thead><tr><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td>StaticRO</td><td>Field is set statically at install-time.</td></tr><tr><td>DynamicRO</td><td>Field is computed dynamically at run time.</td></tr><tr><td>RW</td><td>Field is read/write.</td></tr></tbody></table><ul><li>The ty parameter for the type of the field.</li><li>The default_value parameter.</li><li>The name of the field.</li><li>A documentation string.</li></ul><p>Example of a field in the pool class:</p><pre><code>field ~lifecycle:[Published, rel_orlando, &quot;Controls whether HA is enabled&quot;]
      ~qualifier:DynamicRO ~ty:Bool
      ~default_value:(Some (VBool false)) &quot;ha_enabled&quot; &quot;true if HA is enabled on the pool, false otherwise&quot;;
</code></pre><p>See datamodel_types.ml for information about other parameters.</p><h2 id=changing-constructors>Changing Constructors</h2><p>Adding a field would change the constructors for the class – functions
Db.*.create – and therefore, any references to these in the code need to be
updated. In the example, the argument ~ha_enabled:false should be added to any
call to Db.Pool.create.</p><p>Examples of where these calls can be found is in <code>ocaml/tests/common/test_common.ml</code> and <code>ocaml/xapi/xapi_[class].ml</code>.</p><h3 id=cli-records>CLI Records</h3><p>If you want this field to show up in the CLI (which you probably do), you will
also need to modify the Records module, in the file
<code>ocaml/xapi-cli-server/records.ml</code>. Find the record function for the class which
you have modified, add a new entry to the fields list using make_field. This type can be found in the same file.</p><p>The only required parameters are name and get (and unit, of course ).
If your field is a map or set, then you will need to pass in get_{map,set}, and
optionally set_{map,set}, if it is a RW field. The hidden parameter is useful
if you don&rsquo;t want this field to show up in a *_params_list call. As an example,
here is a field that we&rsquo;ve just added to the SM class:</p><pre><code>make_field ~name:&quot;versioned-capabilities&quot;
           ~get:(fun () -&gt; Record_util.s2sm_to_string &quot;; &quot; (x ()).API.sM_versioned_capabilities)
           ~get_map:(fun () -&gt; (x ()).API.sM_versioned_capabilities)
           ~hidden:true ();
</code></pre><h2 id=testing>Testing</h2><p>The new fields can be tested by copying the newly compiled xapi binary to a
test box. After the new xapi service is started, the file
<em>/var/log/xensource.log</em> in the test box should contain a few lines reporting the
successful upgrade of the metadata schema in the test box:</p><pre><code>[...|xapi] Db has schema major_vsn=5, minor_vsn=57 (current is 5 58) (last is 5 57)
[...|xapi] Database schema version is that of last release: attempting upgrade
[...|sql] attempting to restore database from /var/xapi/state.db
[...|sql] finished parsing xml
[...|sql] writing db as xml to file '/var/xapi/state.db'.
[...|xapi] Database upgrade complete, restarting to use new db
</code></pre><h2 id=making-this-field-accessible-as-a-cli-attribute>Making this field accessible as a CLI attribute</h2><p>XenAPI functions to get and set the value of the new field are generated
automatically. It requires some extra work, however, to enable such operations
in the CLI.</p><p>The CLI has commands such as host-param-list and host-param-get. To make a new
field accessible by these commands, the file <code>xapi-cli-server/records.ml</code> needs to
be edited. For the pool.ha-enabled field, the pool_record function in this file
contains the following (note the convention to replace underscores by hyphens
in the CLI):</p><pre><code>let pool_record rpc session_id pool =
  ...
[
  ...
  make_field ~name:&quot;ha-enabled&quot; ~get:(fun () -&gt; string_of_bool (x ()).API.pool_ha_enabled) ();
  ...
]}
</code></pre><p>NB: the ~get parameter must return a string so include a relevant function to convert the type of the field into a string i.e. <code>string_of_bool</code></p><p>See <code>xapi-cli-server/records.ml</code> for examples of handling field types other than Bool.</p><footer class=footline></footer></article></div></main></div><aside id=sidebar class=default-animation><div id=header-topbar class=default-animation></div><div id=header-wrapper class=default-animation><div id=header class=default-animation><img src=https://xapi-project.github.io/new-docs//images/xapi-project.png></div><div class="searchbox default-animation"><i class="fas fa-search" title="Search (CTRL+ALT+f)"></i>
<label class=a11y-only for=search-by>Search</label>
<input data-search-input id=search-by name=search-by class=search-by type=search placeholder=Search...>
<button class=search-clear type=button data-search-clear title="Clear search"><i class="fas fa-times" title="Clear search"></i></button></div><script>var contentLangs=["en"]</script><script src=/new-docs/js/auto-complete.js?1697450081 defer></script>
<script src=/new-docs/js/lunr/lunr.min.js?1697450081 defer></script>
<script src=/new-docs/js/lunr/lunr.stemmer.support.min.js?1697450081 defer></script>
<script src=/new-docs/js/lunr/lunr.multi.min.js?1697450081 defer></script>
<script src=/new-docs/js/lunr/lunr.en.min.js?1697450081 defer></script>
<script src=/new-docs/js/search.js?1697450081 defer></script></div><div id=homelinks class="default-animation homelinks"><ul><li><a class=padding href=/new-docs/index.html><i class="fas fa-home"></i> Home</a></li></ul><hr class=padding></div><div id=content-wrapper class=highlightable><div id=topics><ul class="enlarge morespace collapsible-menu"><li data-nav-id=/new-docs/toolstack/index.html><input type=checkbox id=section-733bfb8b221c6a3949d666444cf4445d aria-controls=subsections-733bfb8b221c6a3949d666444cf4445d><label for=section-733bfb8b221c6a3949d666444cf4445d><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu The Toolstack</span></label><a class=padding href=/new-docs/toolstack/index.html>The Toolstack</a><ul id=subsections-733bfb8b221c6a3949d666444cf4445d class="morespace collapsible-menu"><li data-nav-id=/new-docs/toolstack/responsibilities/index.html><a class=padding href=/new-docs/toolstack/responsibilities/index.html>Responsibilities</a></li><li data-nav-id=/new-docs/toolstack/high-level/index.html><input type=checkbox id=section-93d1c0b933c799c336ad0fd09a6dc0ae aria-controls=subsections-93d1c0b933c799c336ad0fd09a6dc0ae><label for=section-93d1c0b933c799c336ad0fd09a6dc0ae><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu High-level architecture</span></label><a class=padding href=/new-docs/toolstack/high-level/index.html>High-level architecture</a><ul id=subsections-93d1c0b933c799c336ad0fd09a6dc0ae class="morespace collapsible-menu"><li data-nav-id=/new-docs/toolstack/high-level/environment/index.html><a class=padding href=/new-docs/toolstack/high-level/environment/index.html>Environment</a></li><li data-nav-id=/new-docs/toolstack/high-level/daemons/index.html><a class=padding href=/new-docs/toolstack/high-level/daemons/index.html>Daemons</a></li><li data-nav-id=/new-docs/toolstack/high-level/interfaces/index.html><a class=padding href=/new-docs/toolstack/high-level/interfaces/index.html>Interfaces</a></li></ul></li><li data-nav-id=/new-docs/toolstack/features/index.html><input type=checkbox id=section-a202420b9d8f13c2d690377c4357de50 aria-controls=subsections-a202420b9d8f13c2d690377c4357de50><label for=section-a202420b9d8f13c2d690377c4357de50><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Features</span></label><a class=padding href=/new-docs/toolstack/features/index.html>Features</a><ul id=subsections-a202420b9d8f13c2d690377c4357de50 class="morespace collapsible-menu"><li data-nav-id=/new-docs/toolstack/features/DR/index.html><a class=padding href=/new-docs/toolstack/features/DR/index.html>Disaster Recovery</a></li><li data-nav-id=/new-docs/toolstack/features/HA/index.html><a class=padding href=/new-docs/toolstack/features/HA/index.html>High-Availability</a></li><li data-nav-id=/new-docs/toolstack/features/snapshots/index.html><a class=padding href=/new-docs/toolstack/features/snapshots/index.html>Snapshots</a></li><li data-nav-id=/new-docs/toolstack/features/VGPU/index.html><a class=padding href=/new-docs/toolstack/features/VGPU/index.html>vGPU</a></li><li data-nav-id=/new-docs/toolstack/features/XSM/index.html><a class=padding href=/new-docs/toolstack/features/XSM/index.html>Xapi Storage Migration</a></li></ul></li></ul></li><li data-nav-id=/new-docs/xapi/index.html class=parent><input type=checkbox id=section-38d9a208f329bfd7f57b7a3d82b1b09a aria-controls=subsections-38d9a208f329bfd7f57b7a3d82b1b09a checked><label for=section-38d9a208f329bfd7f57b7a3d82b1b09a><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Xapi</span></label><a class=padding href=/new-docs/xapi/index.html>Xapi</a><ul id=subsections-38d9a208f329bfd7f57b7a3d82b1b09a class="morespace collapsible-menu"><li data-nav-id=/new-docs/xapi/guides/index.html class=parent><input type=checkbox id=section-1e852a9c61356e39c38ffde6aaccdadf aria-controls=subsections-1e852a9c61356e39c38ffde6aaccdadf checked><label for=section-1e852a9c61356e39c38ffde6aaccdadf><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu Guides</span></label><a class=padding href=/new-docs/xapi/guides/index.html>Guides</a><ul id=subsections-1e852a9c61356e39c38ffde6aaccdadf class="morespace collapsible-menu"><li data-nav-id=/new-docs/xapi/guides/howtos/index.html class=parent><input type=checkbox id=section-259bbbeab1560e4f0d61ad99041ab23f aria-controls=subsections-259bbbeab1560e4f0d61ad99041ab23f checked><label for=section-259bbbeab1560e4f0d61ad99041ab23f><i class="fas fa-chevron-down"></i><i class="fas fa-chevron-right"></i><span class=a11y-only>Submenu How to add....</span></label><a class=padding href=/new-docs/xapi/guides/howtos/index.html>How to add....</a><ul id=subsections-259bbbeab1560e4f0d61ad99041ab23f class="morespace collapsible-menu"><li data-nav-id=/new-docs/xapi/guides/howtos/add-class/index.html><a class=padding href=/new-docs/xapi/guides/howtos/add-class/index.html>Adding a Class to the API</a></li><li data-nav-id=/new-docs/xapi/guides/howtos/add-field/index.html class=active><a class=padding href=/new-docs/xapi/guides/howtos/add-field/index.html>Adding a field to the API</a></li><li data-nav-id=/new-docs/xapi/guides/howtos/add-function/index.html><a class=padding href=/new-docs/xapi/guides/howtos/add-function/index.html>Adding a function to the API</a></li><li data-nav-id=/new-docs/xapi/guides/howtos/add-api-extension/index.html><a class=padding href=/new-docs/xapi/guides/howtos/add-api-extension/index.html>Adding a XenAPI extension</a></li></ul></li></ul></li><li data-nav-id=/new-docs/xapi/memory/index.html><a class=padding href=/new-docs/xapi/memory/index.html>Memory</a></li></ul></li><li data-nav-id=/new-docs/xcp-networkd/index.html><a class=padding href=/new-docs/xcp-networkd/index.html>Networkd</a></li></ul></div><div class="padding footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter"></div><div id=menu-footer><hr class="padding default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter"><div id=prefooter class="footerLangSwitch footerVariantSwitch footerVisitedLinks"><ul><li id=select-language-container class=footerLangSwitch><div class="padding menu-control"><i class="fas fa-language fa-fw"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=select-language>Language</label>
<select id=select-language onchange="location=baseUri+this.value"></select></div><div class=clear></div></div></li><li id=select-variant-container class=footerVariantSwitch><div class="padding menu-control"><i class="fas fa-paint-brush fa-fw"></i>
<span>&nbsp;</span><div class=control-style><label class=a11y-only for=select-variant>Theme</label>
<select id=select-variant onchange=window.variants&&variants.changeVariant(this.value)><option id=red value=red selected>Red</option></select></div><div class=clear></div></div><script>window.variants&&variants.markSelectedVariant()</script></li><li class=footerVisitedLinks><div class="padding menu-control"><i class="fas fa-history fa-fw"></i>
<span>&nbsp;</span><div class=control-style><button onclick=clearHistory()>Clear History</button></div><div class=clear></div></div></li></ul></div><div id=footer class=footerFooter></div></div></div></aside><script src=/new-docs/js/clipboard.min.js?1697450081 defer></script>
<script src=/new-docs/js/perfect-scrollbar.min.js?1697450081 defer></script>
<script src=/new-docs/js/theme.js?1697450081 defer></script></body></html>