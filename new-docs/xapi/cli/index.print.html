<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.127.0"><meta name=generator content="Relearn 5.20.0+tip"><meta name=description content><title>XE CLI architecture :: XAPI Toolstack Developer Documentation</title>
<link href=https://xapi-project.github.io/new-docs/xapi/cli/index.html rel=canonical type=text/html title="XE CLI architecture :: XAPI Toolstack Developer Documentation"><link href=/new-docs/xapi/cli/index.xml rel=alternate type=application/rss+xml title="XE CLI architecture :: XAPI Toolstack Developer Documentation"><link href=/new-docs/images/favicon.png?1725972454 rel=icon type=image/png><link href=/new-docs/css/fontawesome-all.min.css?1725972459 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fontawesome-all.min.css?1725972459 rel=stylesheet></noscript><link href=/new-docs/css/nucleus.css?1725972459 rel=stylesheet><link href=/new-docs/css/auto-complete.css?1725972459 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/auto-complete.css?1725972459 rel=stylesheet></noscript><link href=/new-docs/css/perfect-scrollbar.min.css?1725972459 rel=stylesheet><link href=/new-docs/css/fonts.css?1725972459 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fonts.css?1725972459 rel=stylesheet></noscript><link href=/new-docs/css/theme.css?1725972459 rel=stylesheet><link href=/new-docs/css/theme-auto.css?1725972459 rel=stylesheet id=variant-style><link href=/new-docs/css/variant.css?1725972459 rel=stylesheet><link href=/new-docs/css/print.css?1725972459 rel=stylesheet media=print><link href=/new-docs/css/format-print.css?1725972459 rel=stylesheet><link href=/new-docs/css/ie.css?1725972459 rel=stylesheet><script src=/new-docs/js/url.js?1725972459></script><script src=/new-docs/js/variant.js?1725972459></script><script>window.index_js_url="/new-docs/index.search.js";var baseUriFull,root_url="/",baseUri=root_url.replace(/\/$/,"");window.T_Copy_to_clipboard="Copy to clipboard",window.T_Copied_to_clipboard="Copied to clipboard!",window.T_Copy_link_to_clipboard="Copy link to clipboard",window.T_Link_copied_to_clipboard="Copied link to clipboard!",window.T_No_results_found='No results found for "{0}"',window.T_N_results_found='{1} results found for "{0}"',baseUriFull="https://xapi-project.github.io/new-docs/",window.variants&&variants.init(["auto","zen-light","zen-dark","red","blue","green","learn","neon","relearn-light","relearn-bright","relearn-dark"])</script><link rel=stylesheet href=https://xapi-project.github.io/new-docs/css/misc.css></head><body class="mobile-support print" data-url=/new-docs/xapi/cli/index.html><div id=body class=default-animation><div id=sidebar-overlay></div><div id=toc-overlay></div><nav id=topbar class=highlightable><div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle class=topbar-link title='Menu (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a></span><ol class=links itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/index.html><span itemprop=name>XAPI Toolstack Developer Guide</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/xapi/index.html><span itemprop=name>Xapi</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>XE CLI architecture</span><meta itemprop=position content="3"></li></ol></div></div></nav><main id=body-inner class="highlightable default" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=xe-cli-architecture>XE CLI architecture</h1><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>The links in this page point to the source files of xapi
<a href=https://github.com/xapi-project/xen-api/tree/v1.132.0 target=_blank>v1.132.0</a>, not to the
latest source code. Meanwhile, the CLI server code in xapi has been moved to a
library separate from the main xapi binary, and has its own subdirectory
<code>ocaml/xapi-cli-server</code>.</p></div></div><h2 id=architecture>Architecture</h2><ul><li><p><strong>The actual CLI</strong> is a very lightweight binary in
<a href=https://github.com/xapi-project/xen-api/tree/v1.132.0/ocaml/xe-cli target=_blank>ocaml/xe-cli</a></p><ul><li>It is just a dumb client, that does everything that xapi tells
it to do</li><li>This is a security issue<ul><li>We must trust the xenserver that we connect to, because it
can tell xe to read local files, download files, &mldr;</li></ul></li><li>When it is first called, it takes the few command-line arguments
it needs, and then passes the rest to xapi in a HTTP PUT request<ul><li>Each argument is in a separate line</li></ul></li><li>Then it loops doing what xapi tells it to do, in a loop, until
xapi tells it to exit or an exception happens</li></ul></li><li><p><strong>The protocol</strong> description is in
<a href=https://github.com/xapi-project/xen-api/blob/v1.132.0/ocaml/xapi-cli-protocol/cli_protocol.ml target=_blank>ocaml/xapi-cli-protocol/cli_protocol.ml</a></p><ul><li>The CLI has such a protocol that one binary can talk to multiple
versions of xapi as long as their CLI protocol versions are
compatible</li><li>and the CLI can be changed without updating the xe binary</li><li>and also for performance reasons, it is more efficient this way
than by having a CLI that makes XenAPI calls</li></ul></li><li><p><strong>Xapi</strong></p><ul><li>The HTTP POST request is sent to the <code>/cli</code> URL</li><li>In <code>Xapi.server_init</code>, xapi <a href=https://github.com/xapi-project/xen-api/blob/v1.132.0/ocaml/xapi/xapi.ml#L804 target=_blank>registers the appropriate function
to handle these
requests</a>,
defined in <a href=https://github.com/xapi-project/xen-api/blob/v1.132.0/ocaml/xapi/xapi.ml#L589 target=_blank>common_http_handlers in the same
file</a>:
<code>Xapi_cli.handler</code></li><li>The relevant code is in <code>ocaml/xapi/records.ml</code>,
<code>ocaml/xapi/cli_*.ml</code><ul><li>CLI object definitions are in <code>records.ml</code>, command
definitions in <code>cli_frontend.ml</code> (in
<a href=https://github.com/xapi-project/xen-api/blob/v1.132.0/ocaml/xapi/cli_frontend.ml#L72 target=_blank>cmdtable_data</a>),
implementations of commands in <code>cli_operations.ml</code></li></ul></li><li>When a command is received, it is parsed into a command name and
a parameter list of key-value pairs<ul><li>and the command table
<a href=https://github.com/xapi-project/xen-api/blob/v1.132.0/ocaml/xapi/xapi_cli.ml#L157 target=_blank>is</a>
<a href=https://github.com/xapi-project/xen-api/blob/v1.132.0/ocaml/xapi/cli_frontend.ml#L3005 target=_blank>populated
lazily</a>
from the commands defined in <code>cmdtable_data</code> in
<code>cli_frontend.ml</code>, and <a href=https://github.com/xapi-project/xen-api/blob/v1.132.0/ocaml/xapi/cli_operations.ml#L740 target=_blank>automatically
generated</a>
low-level parameter commands (the ones defined in <a href=http://docs.citrix.com/content/dam/docs/en-us/xenserver/xenserver-7-0/downloads/xenserver-7-0-administrators-guide.pdf target=_blank>section
A.3.2 of the XenServer Administrator&rsquo;s
Guide</a>)
are also added for a list of standard classes</li><li>the command table maps command names to records that contain
the implementation of the command, among other things</li></ul></li><li>Then the command name <a href=https://github.com/xapi-project/xen-api/blob/v1.132.0/ocaml/xapi/xapi_cli.ml#L86 target=_blank>is looked
up</a>
in the command table, and the corresponding operation is
executed with the parsed key-value parameter list passed to it</li></ul></li></ul><h2 id=walk-through-cli-handler-in-xapi-external-calls>Walk-through: CLI handler in xapi (external calls)</h2><h3 id=definitions-for-the-http-handler>Definitions for the HTTP handler</h3><pre><code>Constants.cli_uri = &quot;/cli&quot;

Datamodel.http_actions = [...;
  (&quot;post_cli&quot;, (Post, Constants.cli_uri, false, [], _R_READ_ONLY, []));
...]

(* these public http actions will NOT be checked by RBAC *)
(* they are meant to be used in exceptional cases where RBAC is already *)
(* checked inside them, such as in the XMLRPC (API) calls *)
Datamodel.public_http_actions_with_no_rbac_check` = [...
  &quot;post_cli&quot;;  (* CLI commands -&gt; calls XMLRPC *)
...]

Xapi.common_http_handlers = [...;
  (&quot;post_cli&quot;, (Http_svr.BufIO Xapi_cli.handler));
...]

Xapi.server_init () =
  ...
  &quot;Registering http handlers&quot;, [], (fun () -&gt; List.iter Xapi_http.add_handler common_http_handlers);
  ...
</code></pre><p>Due to there definitions, <code>Xapi_http.add_handler</code> does not perform RBAC checks for <code>post_cli</code>. This means that the CLI handler does not use <code>Xapi_http.assert_credentials_ok</code> when a request comes in, as most other handlers do. The reason is that RBAC checking is delegated to the actual XenAPI calls that are being done by the commands in <code>Cli_operations</code>.</p><p>This means that the <code>Xapi_http.add_handler call</code> so resolves to simply:</p><pre><code>Http_svr.Server.add_handler server Http.Post &quot;/cli&quot; (Http_svr.BufIO Xapi_cli.handler))
</code></pre><p>&mldr;which means that the function <code>Xapi_cli.handler</code> is called directly when an HTTP POST request with path <code>/cli</code> comes in.</p><h3 id=high-level-request-processing>High-level request processing</h3><p><code>Xapi_cli.handler</code>:</p><ul><li>Reads the body of the HTTP request, limitted to <code>Xapi_globs.http_limit_max_cli_size = 200 * 1024</code> characters.</li><li>Sends a protocol version string to the client: <code>"XenSource thin CLI protocol"</code> plus binary encoded major (0) and (2) minor numbers.</li><li>Reads the protocol version from the client and exits with an error if it does not match the above.</li><li>Calls <code>Xapi_cli.parse_session_and_args</code> with the request&rsquo;s body to extract the session ref, if there.</li><li>Calls <code>Cli_frontend.parse_commandline</code> to parse the rest of the command line from the body.</li><li>Calls <code>Xapi_cli.exec_command</code> to execute the command.</li><li>On error, calls <code>exception_handler</code>.</li></ul><p><code>Xapi_cli.parse_session_and_args</code>:</p><ul><li>Is passed the request body and reads it line by line. Each line is considered an argument.</li><li>Removes any CR chars from the end of each argument.</li><li>If the first arg starts with <code>session_id=</code>, the the bit after this prefix is considered to be a session reference.</li><li>Returns the session ref (if there) and (remaining) list of args.</li></ul><p><code>Cli_frontend.parse_commandline</code>:</p><ul><li>Returns the command name and assoc list of param names and values. It handles <code>--name</code> and <code>-flag</code> arguments by turning them into key/value string pairs.</li></ul><p><code>Xapi_cli.exec_command</code>:</p><ul><li>Finds username/password params.</li><li>Get the rpc function: this is the so-called &ldquo;<code>fake_rpc</code> callback&rdquo;, which does not use the network or HTTP at all, but goes straight to <code>Api_server.callback1</code> (the XenAPI RPC entry point). This function is used by the CLI handler to do loopback XenAPI calls.</li><li>Logs the parsed xe command, omitting sensitive data.</li><li>Continues as <code>Xapi_cli.do_rpcs</code></li><li>Looks up the command name in the command table from <code>Cli_frontend</code> (raises an error if not found).</li><li>Checks if all required params have been supplied (raises an error if not).</li><li>Checks that the host is a pool master (raises an error if not).</li><li>Depending on the command, a <code>session.login_with_password</code> or <code>session.slave_local_login_with_password</code> XenAPI call is made with the supplied username and password. If the authentication passes, then a session reference is returned for the RBAC role that belongs to the user. This session is used to do further XenAPI calls.</li><li>Next, the implementation of the command in <code>Cli_operations</code> is executed.</li></ul><h3 id=command-implementations>Command implementations</h3><p>The various commands are implemented in <code>cli_operations.ml</code>. These functions are only called after user authentication has passed (see above). However, RBAC restrictions are only enforced inside any XenAPI calls that are made, and <em>not</em> on any of the other code in <code>cli_operations.ml</code>.</p><p>The type of each command implementation function is as follows (see <code>cli_cmdtable.ml</code>):</p><pre><code>type op =
  Cli_printer.print_fn -&gt;
  (Rpc.call -&gt; Rpc.response) -&gt;
  API.ref_session -&gt; ((string*string) list) -&gt; unit
</code></pre><p>So each function receives a printer for sending text output to the xe client, and rpc function and session reference for doing XenAPI calls, and a key/value pair param list. Here is a typical example:</p><pre><code>let bond_create printer rpc session_id params =
  let network = List.assoc &quot;network-uuid&quot; params in
  let mac = List.assoc_default &quot;mac&quot; params &quot;&quot; in
  let network = Client.Network.get_by_uuid rpc session_id network in
  let pifs = List.assoc &quot;pif-uuids&quot; params in
  let uuids = String.split ',' pifs in
  let pifs = List.map (fun uuid -&gt; Client.PIF.get_by_uuid rpc session_id uuid) uuids in
  let mode = Record_util.bond_mode_of_string (List.assoc_default &quot;mode&quot; params &quot;&quot;) in
  let properties = read_map_params &quot;properties&quot; params in
  let bond = Client.Bond.create rpc session_id network pifs mac mode properties in
  let uuid = Client.Bond.get_uuid rpc session_id bond in
  printer (Cli_printer.PList [ uuid])
</code></pre><ul><li>The necessary parameters are looked up in <code>params</code> using <code>List.assoc</code> or similar.</li><li>UUIDs are translated into reference by <code>get_by_uuid</code> XenAPI calls (note that the <code>Client</code> module is the XenAPI client, and functions in there require the rpc function and session reference).</li><li>Then the main API call is made (<code>Client.Bond.create</code> in this case).</li><li>Further API calls may be made to output data for the client, and passed to the <code>printer</code>.</li></ul><p>This is the common case for CLI operations: they do API calls based on the parameters that were passed in.</p><p>However, other commands are more complicated, for example <code>vm_import/export</code> and <code>vm_migrate</code>. These contain a lot more logic in the CLI commands, and also send commands to the client to instruct it to read or write files and/or do HTTP calls.</p><p>Yet other commands do not actually do any XenAPI calls, but instead get &ldquo;helpful&rdquo; information from other places. Example: <code>diagnostic_gc_stats</code>, which displays statistics from xapi&rsquo;s OCaml GC.</p><h2 id=tutorials>Tutorials</h2><p>The following tutorials show how to extend the CLI (and XenAPI):</p><ul><li><a href=/new-docs/xapi/guides/howtos/add-field/>Adding a field</a></li><li><a href=/new-docs/xapi/guides/howtos/add-function/>Adding an operation</a></li></ul><footer class=footline></footer></article></div></main></div><script src=/new-docs/js/clipboard.min.js?1725972459 defer></script><script src=/new-docs/js/perfect-scrollbar.min.js?1725972459 defer></script><script src=/new-docs/js/theme.js?1725972459 defer></script></body></html>