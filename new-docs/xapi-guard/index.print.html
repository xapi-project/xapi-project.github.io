<!doctype html><html lang=en-us dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.127.0"><meta name=generator content="Relearn 7.3.2"><meta name=description content="The xapi-guard daemon is the component in the xapi toolstack that is responsible for handling persistence requests from VMs (domains). Currently these are UEFI vars and vTPM updates.
The code is in ocaml/xapi-guard. When the daemon managed only with UEFI updates it was called varstored-guard. Some files and package names still use the previous name.
Principles Calls from domains must be limited in privilege to do certain API calls, and to read and write from their corresponding VM in xapiâ€™s database only."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Xapi-guard :: XAPI Toolstack Developer Documentation"><meta name=twitter:description content="The xapi-guard daemon is the component in the xapi toolstack that is responsible for handling persistence requests from VMs (domains). Currently these are UEFI vars and vTPM updates.
The code is in ocaml/xapi-guard. When the daemon managed only with UEFI updates it was called varstored-guard. Some files and package names still use the previous name.
Principles Calls from domains must be limited in privilege to do certain API calls, and to read and write from their corresponding VM in xapiâ€™s database only."><meta property="og:url" content="https://xapi-project.github.io/new-docs/xapi-guard/index.html"><meta property="og:site_name" content="XAPI Toolstack Developer Documentation"><meta property="og:title" content="Xapi-guard :: XAPI Toolstack Developer Documentation"><meta property="og:description" content="The xapi-guard daemon is the component in the xapi toolstack that is responsible for handling persistence requests from VMs (domains). Currently these are UEFI vars and vTPM updates.
The code is in ocaml/xapi-guard. When the daemon managed only with UEFI updates it was called varstored-guard. Some files and package names still use the previous name.
Principles Calls from domains must be limited in privilege to do certain API calls, and to read and write from their corresponding VM in xapiâ€™s database only."><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta itemprop=name content="Xapi-guard :: XAPI Toolstack Developer Documentation"><meta itemprop=description content="The xapi-guard daemon is the component in the xapi toolstack that is responsible for handling persistence requests from VMs (domains). Currently these are UEFI vars and vTPM updates.
The code is in ocaml/xapi-guard. When the daemon managed only with UEFI updates it was called varstored-guard. Some files and package names still use the previous name.
Principles Calls from domains must be limited in privilege to do certain API calls, and to read and write from their corresponding VM in xapiâ€™s database only."><meta itemprop=wordCount content="767"><title>Xapi-guard :: XAPI Toolstack Developer Documentation</title>
<link href=https://xapi-project.github.io/new-docs/xapi-guard/index.html rel=canonical type=text/html title="Xapi-guard :: XAPI Toolstack Developer Documentation"><link href=/new-docs/xapi-guard/index.xml rel=alternate type=application/rss+xml title="Xapi-guard :: XAPI Toolstack Developer Documentation"><link href=/new-docs/images/favicon.png?1752660122 rel=icon type=image/png><link href=/new-docs/css/fontawesome-all.min.css?1752660122 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/fontawesome-all.min.css?1752660122 rel=stylesheet></noscript><link href=/new-docs/css/auto-complete.css?1752660122 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/new-docs/css/auto-complete.css?1752660122 rel=stylesheet></noscript><link href=/new-docs/css/perfect-scrollbar.min.css?1752660122 rel=stylesheet><link href=/new-docs/css/theme.min.css?1752660122 rel=stylesheet><link href=/new-docs/css/format-print.min.css?1752660122 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.relBasePath="..",window.relearn.relBaseUri="../..",window.relearn.absBaseUri="https://xapi-project.github.io/new-docs",window.relearn.min=`.min`,window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.themevariants=["auto","zen-light","zen-dark","red","blue","green","learn","neon","relearn-light","relearn-bright","relearn-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}}))},window.relearn.markVariant=function(){var t=window.localStorage.getItem(window.relearn.absBaseUri+"/variant"),e=document.querySelector("#R-select-variant");e&&(e.value=t)},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant(),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><link rel=stylesheet href=https://xapi-project.github.io/new-docs/css/misc.css></head><body class="mobile-support print" data-url=/new-docs/xapi-guard/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><a href=#principles>Principles</a></li><li><a href=#overview>Overview</a></li><li><a href=#structure>Structure</a></li><li><a href=#startup>Startup</a></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/new-docs/index.html><span itemprop=name>XAPI Toolstack Developer Guide</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Xapi-guard</span><meta itemprop=position content="2"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-edit" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=https://github.com/xapi-project/xen-api/edit/master/doc/content/xapi-guard/_index.md target=_blank title="Edit (CTRL+ALT+w)"><i class="fa-fw fas fa-pen"></i></a></div><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/xapi-guard/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/squeezed/design/index.html title="Design (ðŸ¡)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/new-docs/design/index.html title="Design Documents (ðŸ¡’)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable xapi-guard" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=xapi-guard>Xapi-guard</h1><p>The <code>xapi-guard</code> daemon is the component in the xapi toolstack that is responsible for handling persistence requests from VMs (domains).
Currently these are UEFI vars and vTPM updates.</p><p>The code is in <code>ocaml/xapi-guard</code>.
When the daemon managed only with UEFI updates it was called <code>varstored-guard</code>.
Some files and package names still use the previous name.</p><h2 id=principles>Principles</h2><ol><li>Calls from domains must be limited in privilege to do certain API calls, and
to read and write from their corresponding VM in xapi&rsquo;s database only.</li><li>Xenopsd is able to control xapi-guard through message switch, this access is
not limited.</li><li>Listening to domain socket is restored whenever the daemon restarts to minimize disruption of running domains.</li><li>Disruptions to requests when xapi is unavailable is minimized.
The startup procedure is not blocked by the availability of xapi, and write requests from domains must not fail because xapi is unavailable.</li></ol><h2 id=overview>Overview</h2><p>Xapi-guard forwards calls from domains to xapi to persist UEFI variables, and update vTPMs.
To do this, it listens to 1 socket per service (varstored, or swtpm) per domain.
To create these sockets before the domains are running, it listens to a message-switch socket.
This socket listens to calls from xenopsd, which orchestrates the domain creation.</p><p>To protect the domains from xapi being unavailable transiently, xapi-guard provides an on-disk cache for vTPM writes.
This cache acts as a buffer and stores the requests temporarily until xapi can be contacted again.
This situation usually happens when xapi is being restarted as part of an update.
SWTPM, the vTPM daemon, reads the contents of the TPM from xapi-guard on startup, suspend, and resume.
During normal operation SWTPM does not send read requests from xapi-guard.</p><h2 id=structure>Structure</h2><p>The cache module consists of two Lwt threads, one that writes to disk, and another one that reads from disk.
The writer is triggered when a VM writes to the vTPM.
It never blocks if xapi is unreachable, but responds as soon as the data has been stored either by xapi or on the local disk, such that the VM receives a timely response to the write request.
Both try to send the requests to xapi, depending on the state, to attempt write all the cached data back to xapi, and stop using the cache.
The threads communicate through a bounded queue, this is done to limit the amount of memory used.
This queue is a performance optimisation, where the writer informs the reader precisely which are the names of the cache files, such that the reader does not need to list the cache directory.
And a full queue does not mean data loss, just a loss of performance; vTPM writes are still cached.</p><p>This means that the cache operates in three modes:</p><ul><li>Direct: during normal operation the disk is not used at all</li><li>Engaged: both threads use the queue to order events</li><li>Disengaged: A thread dumps request to disk while the other reads the cache
until it&rsquo;s empty</li></ul><pre class="mermaid align-center">---
title: Cache State
---
stateDiagram-v2
    Disengaged
    note right of Disengaged
        Writer doesn&#39;t add requests to queue
        Reader reads from cache and tries to push to xapi
    end note
    Direct
    note left of Direct
        Writer bypasses cache, send to xapi
        Reader waits
    end note
    Engaged
    note right of Engaged
        Writer writes to cache and adds requests to queue
        Reader reads from queue and tries to push to xapi
    end note

    [*] --&gt; Disengaged

    Disengaged --&gt; Disengaged : Reader pushed pending TPMs to xapi, in the meantime TPMs appeared in the cache
    Disengaged --&gt; Direct : Reader pushed pending TPMs to xapi, cache is empty

    Direct --&gt; Direct : Writer receives TPM, sent to xapi
    Direct --&gt; Engaged : Writer receives TPM, error when sent to xapi

    Engaged --&gt; Direct : Reader sent TPM to xapi, finds an empty queue
    Engaged --&gt; Engaged : Writer receives TPM, queue is not full
    Engaged --&gt; Disengaged : Writer receives TPM, queue is full</pre><h2 id=startup>Startup</h2><p>At startup, there&rsquo;s a dedicated routine to transform the existing contents of the cache.
This is currently done because the timestamp reference change on each boot.
This means that the existing contents might have timestamps considered more recent than timestamps of writes coming from running events, leading to missing content updates.
This must be avoided and instead the updates with offending timestamps are renamed to a timestamp taken from the current timestamp, ensuring a consistent
ordering.
The routine is also used to keep a minimal file tree: unrecognised files are deleted, temporary files created to ensure atomic writes are left untouched, and empty directories are deleted.
This mechanism can be changed in the future to migrate to other formats.</p><script>for(let e of document.querySelectorAll(".inline-type"))e.innerHTML=renderType(e.innerHTML)</script><footer class=footline></footer></article></div></main></div><script src=/new-docs/js/clipboard.min.js?1752660122 defer></script><script src=/new-docs/js/perfect-scrollbar.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-color.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-dispatch.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-drag.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-ease.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-interpolate.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-selection.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-timer.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-transition.min.js?1752660122 defer></script><script src=/new-docs/js/d3/d3-zoom.min.js?1752660122 defer></script><script src=/new-docs/js/js-yaml.min.js?1752660122 defer></script><script src=/new-docs/js/mermaid.min.js?1752660122 defer></script><script>window.themeUseMermaid=JSON.parse('{ "fontFamily": "Roboto Flex", "securityLevel": "loose" }')</script><script src=/new-docs/js/theme.js?1752660122 defer></script><script>function apply_image_invert_filter(e){document.querySelectorAll("img").forEach(function(t){if(t.classList.contains("no-invert"))return;t.style="filter: invert("+e+");"})}function darkThemeUsed(){const t=window.getComputedStyle(document.querySelector("body")),n=t.getPropertyValue("background-color");var e=n.match(/\d+/g).map(function(e){return parseInt(e,10)});return e.length===3&&.2126*e[0]+.7152*e[1]+.0722*e[2]<165}const invertToDarkGray=.85;darkThemeUsed()&&apply_image_invert_filter(invertToDarkGray),document.addEventListener("themeVariantLoaded",function(e){apply_image_invert_filter(e.detail.variant.endsWith("dark")?invertToDarkGray:0)})</script></body></html>